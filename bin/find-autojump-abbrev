#!/bin/zsh
# script to find the shortest abbreviation for autojump for the current, or given directory
dangerous() {
    if [[ $1 == "-i" ]]; then
        echo "sorry, can't check for -i"
        return 0
    fi
    if [[ $1 == "-s" ]]; then
        echo "sorry, can't check for -s"
        return 0
    fi
    return 1
}

if [ -z "$1" ]; then
    directory=$PWD
else
    directory=$(realpath $1)
    if [ ! -d "$directory" ]; then
        echo "$directory is not a valid, existing directory"
        exit
    fi
fi

basename=$(basename $directory | tr '[:upper:]' '[:lower:]')
characters=()
for ((i = 0; i < ${#basename}; i++)); do
    characters+=${basename:$i:1}
done

answers=()
for c in "${characters[@]}"; do
    if [[ $basename == *"$c"* ]]; then
        local dir=$(zoxide query $c 2>/dev/null || true)

        if [[ "$dir" == "$directory" ]]; then
            answers+=$c
        fi
    fi
done
if [ ${#answers[@]} -gt 0 ]; then
    # only type unique abbreviations
    echo "${answers[@]}" | tr ' ' '\n' | awk '!a[$0]++'
    exit
fi

for c in "${characters[@]}"; do
    if [[ $basename == *"$c"* ]]; then
        for d in "${characters[@]}"; do
            if dangerous $c$d; then
                continue
            fi

            local dir=$(zoxide query $c$d 2>/dev/null || true)

            if [[ "$dir" == "$directory" ]]; then
                answers+=$c$d
            fi
        done
    fi
done
if [ ${#answers[@]} -gt 0 ]; then
    # only type unique abbreviations
    echo "${answers[@]}" | tr ' ' '\n' | awk '!a[$0]++'
    exit
fi
echo "No one or two character abbreviation found for $(basename $directory)"

for c in "${characters[@]}"; do
    if [[ $basename == *"$c"* ]]; then
        for d in "${characters[@]}"; do
            if dangerous $c$d; then
                continue
            fi
            if [[ $basename == *"$d"* ]]; then
                for e in "${characters[@]}"; do
                    local dir=$(zoxide query $c$d$e 2>/dev/null || true)

                    if [[ "$dir" == "$directory" ]]; then
                        echo - $c$d$e
                        exit
                    fi
                done
            fi
        done
        echo "No three character abbreviation starting with $c found for $(basename $directory)"
    fi
done

echo "No abbreviation found for $(basename $directory)"
