#!/bin/zsh
# script to find the shortest abbreviation for autojump for the current, or given directory

dangerous() {
    # these cannot be arguments to zoxide query
    if [[ $1 == "-i" ]]; then
        echo "sorry, can't check for -i"
        return 0
    fi
    if [[ $1 == "-s" ]]; then
        echo "sorry, can't check for -s"
        return 0
    fi
    if [[ $1 == " " ]]; then
        echo "space is a bad abbreviation"
        return 0
    fi
    return 1
}

if [ -z "$1" ]; then
    directory=$PWD
else
    directory=$(realpath $1)
    if [ ! -d "$directory" ]; then
        echo "$directory is not a valid, existing directory"
        exit
    fi
fi

basename=$(basename $directory | tr '[:upper:]' '[:lower:]')

baseLength=${#basename}
for ((length = 1; length < baseLength + 1; length++)); do
    answers=()
    for ((offset = 0; offset < $((baseLength - length + 1)); offset++)); do
        local fragment=${basename:$offset:$length}
        if dangerous $fragment; then
            continue
        fi
        local dir=$(zoxide query $fragment 2>/dev/null || true)

        if [[ "$dir" == "$directory" ]]; then
            answers+=$fragment
        fi
    done
    if [ ${#answers[@]} -gt 0 ]; then
        # only type unique abbreviations
        echo "${answers[@]}" | tr ' ' '\n' | awk '!a[$0]++'
        exit
    fi
done

echo "No abbreviation found for $(basename $directory)"
