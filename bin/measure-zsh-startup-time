#!/bin/bash
command='zsh -i -c exit'
min_runs=10
warmup=1

usage () { echo "OPTIONS:

-c command to profile, e.g. 'bash -i -l -c exit'
-m minimum number of runs
-w number of warmup runs
-v verbose"; }

while getopts "hvc:m:w:" opt; do
    case $opt in
        c ) command=$OPTARG;;
        m ) min_runs=$OPTARG;;
        w ) warmup=$OPTARG;;
        v ) verbose=1;;
        h ) usage; exit;;
    esac
done

if [ -x "$(command -v hyperfine)" ]; then
  hyperfine --warmup $warmup --min-runs $min_runs "$command"
else
  FILENAME=`mktemp`
  for ((i=1;i<=$warmup;i++)); do
    `time $command`
  done > /dev/null 2>&1
  for ((i=1;i<=$min_runs;i++)); do
    `time $command`
  done 2>&1 | grep real | sed 's/real//' | sed 's/0m//' | sed 's/s$//' | tr -d "[:blank:]" | sort > $FILENAME
  if [ -n "$verbose" ]; then
    cat $FILENAME
  fi

  awk '{ sum += $1; sum_square += $1^2 } \
  END { \
    printf "Runs\t%4d\nTotal\t%4.2gs\nSt.dev.\t%4.2gms\nAverage\t%4.0fms\n", \
      NR, sum, sqrt(sum_square/NR-(sum/NR)^2)*1000, sum/NR*1000 \
  }' $FILENAME
fi
